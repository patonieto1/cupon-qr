<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>CÉLINE — Cupón de beneficio</title>

  <style>
    :root{
      --bg:#0b0b0c;
      --card:rgba(255,255,255,.08);
      --card2:rgba(255,255,255,.06);
      --text:#f2f2f2;
      --muted:rgba(255,255,255,.72);
      --line:rgba(255,255,255,.14);
      --btn:#ffffff;
      --btnText:#0b0b0c;
      --shadow: 0 20px 60px rgba(0,0,0,.55);
      --radius: 18px;
      --gold: rgba(208, 177, 120, .95);
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      color:var(--text);
      background:
        radial-gradient(900px 600px at 20% 10%, rgba(255,255,255,.10), transparent 60%),
        radial-gradient(900px 600px at 90% 30%, rgba(255,255,255,.08), transparent 60%),
        linear-gradient(180deg, #0b0b0c 0%, #0b0b0c 60%, #090909 100%);
      min-height:100vh;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:28px 14px;
    }
    .wrap{width:100%; max-width:560px;}
    .card{
      background: linear-gradient(180deg, var(--card) 0%, var(--card2) 100%);
      border:1px solid var(--line);
      border-radius:20px;
      box-shadow: var(--shadow);
      overflow:hidden;
      backdrop-filter: blur(14px);
    }
    .banner{
      width:100%;
      height:150px;
      background:
        linear-gradient(180deg, rgba(0,0,0,.10), rgba(0,0,0,.65)),
        url("BANER.jpeg");
      background-size: cover;
      background-position: center;
      display:flex;
      align-items:flex-end;
      padding:18px 18px 16px;
      border-bottom:1px solid var(--line);
    }
    .brand .title{
      font-weight:800;
      letter-spacing:.22em;
      text-transform:uppercase;
      font-size:18px;
    }
    .brand .sub{
      margin-top:6px;
      font-size:12px;
      color:var(--muted);
      letter-spacing:.12em;
      text-transform:uppercase;
    }
    .content{padding:18px;}
    h1{margin:6px 0 8px; font-size:28px;}
    p{margin:0 0 14px; color:var(--muted); font-size:14px; line-height:1.45}

    .grid{display:grid; gap:12px; margin-top:8px;}
    label{display:block; font-size:12px; color:var(--muted); margin:0 0 6px; letter-spacing:.06em; text-transform:uppercase;}
    input, select{
      width:100%;
      padding:12px 12px;
      border-radius:12px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.06);
      color:var(--text);
      outline:none;
      font-size:14px;
    }
    input::placeholder{color:rgba(255,255,255,.45)}
    input:focus, select:focus{border-color:rgba(255,255,255,.30)}
    select option{color:#111}

    /* Teléfono: código país (selector) + número al lado */
    .rowPhone{
      display:grid;
      grid-template-columns: 220px 1fr;
      gap:12px;
      align-items:end;
    }
    @media (max-width:420px){
      .rowPhone{ grid-template-columns: 1fr; }
    }

    .hint{color:rgba(255,255,255,.60); font-size:12px; line-height:1.35; margin-top:-6px;}
    .btn{
      margin-top:10px;
      width:100%;
      padding:13px 14px;
      border:0;
      border-radius:14px;
      background:var(--btn);
      color:var(--btnText);
      font-weight:900;
      letter-spacing:.08em;
      cursor:pointer;
      transition: transform .06s ease, opacity .2s ease;
      text-transform:uppercase;
    }
    .btn:disabled{opacity:.6; cursor:not-allowed}
    .btn:active{transform: scale(.99)}
    .btn.ghost{
      background: transparent;
      color: var(--text);
      border:1px solid var(--line);
      margin-top:10px;
    }
    .status{
      display:none;
      border:1px solid var(--line);
      border-radius:14px;
      padding:10px 12px;
      background: rgba(0,0,0,.25);
      color:rgba(255,255,255,.88);
      font-size:13px;
    }
    .status.bad{ border-color: rgba(255, 77, 77, .35); }

    /* Cupón visual */
    .couponWrap{
      display:none;
      padding:18px;
      border-top:1px solid var(--line);
      background: rgba(0,0,0,.25);
    }
    .coupon{
      border-radius:18px;
      overflow:hidden;
      border:1px solid rgba(255,255,255,.18);
      box-shadow: 0 18px 60px rgba(0,0,0,.55);
      background:
        linear-gradient(180deg, rgba(0,0,0,.25), rgba(0,0,0,.75)),
        url("BANER.jpeg");
      background-size: cover;
      background-position: center;
      padding:18px;
      position:relative;
    }
    .coupon::after{
      content:"";
      position:absolute; inset:0;
      background: radial-gradient(800px 280px at 20% 0%, rgba(208,177,120,.18), transparent 55%);
      pointer-events:none;
    }
    .couponTop{
      position:relative;
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:10px;
    }
    .couponBrand{
      font-weight:900;
      letter-spacing:.22em;
      text-transform:uppercase;
      font-size:16px;
    }
    .couponTag{
      margin-top:6px;
      font-size:12px;
      letter-spacing:.12em;
      text-transform:uppercase;
      color:rgba(255,255,255,.75);
    }
    .badge{
      position:relative;
      border:1px solid rgba(208,177,120,.55);
      color: var(--gold);
      padding:8px 10px;
      border-radius:999px;
      font-weight:800;
      letter-spacing:.12em;
      font-size:11px;
      background: rgba(0,0,0,.25);
      white-space:nowrap;
    }
    .codeBox{
      position:relative;
      margin-top:16px;
      padding:14px 14px;
      border-radius:14px;
      border:1px dashed rgba(255,255,255,.35);
      background: rgba(0,0,0,.30);
      text-align:center;
    }
    .code{
      font-size:26px;
      font-weight:1000;
      letter-spacing:.16em;
      word-break:break-word;
    }
    .couponMeta{
      position:relative;
      margin-top:12px;
      display:grid;
      gap:6px;
      color:rgba(255,255,255,.78);
      font-size:12px;
      line-height:1.35;
    }
    .smallLine{opacity:.85;}
    .legal{margin-top:12px; font-size:12px; color:rgba(255,255,255,.55); line-height:1.35;}
  </style>
</head>

<body>
  <div class="wrap">
    <div class="card">
      <div class="banner">
        <div class="brand">
          <div class="title">CÉLINE</div>
          <div class="sub">POP-UP CAFÉ BAR • C’est la vie</div>
        </div>
      </div>

      <div class="content" id="formArea">
        <h1>Cupón de beneficio</h1>
        <p>Completa tus datos y genera tu cupón. Presenta el cupón en caja para validación.</p>

        <form id="f">
          <div class="grid">
            <div>
              <label for="nombre">Nombre y apellido</label>
              <input id="nombre" placeholder="Ej. Juan Pérez" required />
            </div>

            <!-- Teléfono en una sola fila (sin repetidos) -->
            <div class="rowPhone">
              <div>
                <label for="pais">Código país</label>
                <select id="pais" required>
                  <option value="" selected disabled>Selecciona…</option>
                  <option value="Ecuador" data-code="+593">Ecuador (+593)</option>
                  <option value="Estados Unidos" data-code="+1">Estados Unidos (+1)</option>
                  <option value="Colombia" data-code="+57">Colombia (+57)</option>
                  <option value="Perú" data-code="+51">Perú (+51)</option>
                  <option value="España" data-code="+34">España (+34)</option>
                  <option value="Otro" data-code="">Otro (escribe tu código)</option>
                </select>
              </div>

              <div>
                <label for="celular">WhatsApp</label>
                <input id="celular" placeholder="Ej. 0991234567" inputmode="numeric" required pattern="^[0-9]{6,15}$" />
              </div>
            </div>
            <div class="hint">En WhatsApp escribe solo dígitos. Si eliges “Otro”, te pedirá el código país.</div>

            <!-- Código país REAL que se guarda (oculto) -->
            <input type="hidden" id="codigo_pais" value="+593" />

            <div>
              <label for="email">Correo</label>
              <input id="email" type="email" placeholder="Ej. nombre@gmail.com" required />
            </div>

            <div>
              <label for="red">Red favorita</label>
              <select id="red" required>
                <option value="" selected disabled>Selecciona…</option>
                <option value="Instagram">Instagram</option>
                <option value="TikTok">TikTok</option>
              </select>
            </div>

            <div>
              <label for="usuario">Usuario real / link</label>
              <input id="usuario" placeholder="@tuusuario o https://..." required />
              <div class="hint">Debe ser real: <b>@usuario</b> o un link válido (<b>https://...</b>).</div>
            </div>

            <button class="btn" id="btn" type="submit">Generar cupón</button>

            <div class="status" id="status"></div>

            <div class="legal">
              Al enviar aceptas que <b>CÉLINE</b> use estos datos solo para esta promoción y novedades.
            </div>
          </div>
        </form>
      </div>

      <!-- Cupón visual -->
      <div class="couponWrap" id="couponWrap">
        <div class="coupon">
          <div class="couponTop">
            <div>
              <div class="couponBrand">CÉLINE</div>
              <div class="couponTag">CUPÓN ESPECIAL</div>
            </div>
            <div class="badge">VÁLIDO</div>
          </div>

          <div class="codeBox">
            <div class="code" id="couponCode">—</div>
          </div>

          <div class="couponMeta">
            <div class="smallLine" id="couponName">Cliente: —</div>
            <div class="smallLine" id="couponSocial">Red: —</div>
            <div class="smallLine">Presenta este cupón en caja para validar tu beneficio.</div>
          </div>
        </div>

        <button class="btn ghost" id="newBtn" type="button">Hacer otro cupón</button>
        <div class="legal">*Si el staff no encuentra tu código en la base, el cupón no aplica.</div>
      </div>
    </div>
  </div>

<script>
  // ✅ TU URL /exec
  const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxuqU7JeMiO8e1XSjNMsvqWrTEeefNWSaRNAmT4SZSVxZRyTz6gSSggypQpAILVyjGSkQ/exec";

  const $ = (id) => document.getElementById(id);

  // Selector país → setea código país oculto
  $("pais").addEventListener("change", () => {
    const opt = $("pais").options[$("pais").selectedIndex];
    const code = opt.getAttribute("data-code") || "";

    if (opt.value === "Otro") {
      const custom = prompt("Escribe tu código país (ej: +49, +44, +598):", "+");
      if (custom && /^\+\d{1,4}$/.test(custom.trim())) {
        $("codigo_pais").value = custom.trim();
      } else {
        $("codigo_pais").value = "+";
        $("pais").value = "";
        showStatus("❌ Código país inválido. Usa formato +###", true);
      }
      return;
    }

    if (code) $("codigo_pais").value = code;
  });

  // Validación básica de usuario/link
  function isValidUserOrLink(v){
    const s = (v || "").trim();
    if (!s) return false;
    const isHandle = /^@[a-zA-Z0-9._]{2,30}$/.test(s);
    const isUrl = /^https?:\/\/[^\s]+$/i.test(s);
    return isHandle || isUrl;
  }

  // Código con “trampa” para staff:
  // Prefijo: NN + Letra (ej: 99A)
  // Sufijo:  (100-NN) + Letra espejo (A<->Z, B<->Y, etc.) (ej: 01Z)
  function makeTrapCode(){
    const n = Math.floor(Math.random() * 99) + 1;           // 1..99
    const letterIndex = Math.floor(Math.random() * 26);      // 0..25

    const prefixNum = String(n).padStart(2,"0");
    const prefixLetter = String.fromCharCode(65 + letterIndex);

    const suffixNum = String(100 - n).padStart(2,"0");
    const suffixLetter = String.fromCharCode(90 - letterIndex); // espejo

    const chars = "ABCDEFGHJKLMNPQRSTUVWXYZ23456789";
    let mid = "";
    for (let i=0;i<5;i++) mid += chars[Math.floor(Math.random()*chars.length)];

    return `${prefixNum}${prefixLetter}-${mid}-${suffixNum}${suffixLetter}`;
  }

  function showStatus(text, isBad=false){
    const s = $("status");
    s.style.display = "block";
    s.textContent = text;
    s.className = "status" + (isBad ? " bad" : "");
  }

  function normalizeDigits(v){ return String(v || "").replace(/\D/g,""); }

  // Bloqueo local (mismo dispositivo): si ya hay cupón para ese WA_FULL, no deja otra vez
  function isAlreadyGenerated(waFull){
    return localStorage.getItem("CELINE_COUPON_" + waFull) === "1";
  }
  function markGenerated(waFull){
    localStorage.setItem("CELINE_COUPON_" + waFull, "1");
  }

  // UI refs
  const formArea = $("formArea");
  const couponWrap = $("couponWrap");
  const couponCodeEl = $("couponCode");
  const couponNameEl = $("couponName");
  const couponSocialEl = $("couponSocial");
  const btn = $("btn");

  $("f").addEventListener("submit", async (e) => {
    e.preventDefault();

    const nombre = $("nombre").value.trim();
    const pais = $("pais").value.trim();
    const codigo_pais = $("codigo_pais").value.trim();
    const celular = normalizeDigits($("celular").value);
    const email = $("email").value.trim().toLowerCase();
    const red = $("red").value.trim();
    const usuario = $("usuario").value.trim();

    if (!nombre || !pais || !codigo_pais || !celular || !email || !red || !usuario) {
      showStatus("❌ Completa todos los campos.", true);
      return;
    }
    if (!/^\+\d{1,4}$/.test(codigo_pais)) {
      showStatus("❌ Código país inválido (ej: +593).", true);
      return;
    }
    if (!/^\d{6,15}$/.test(celular)) {
      showStatus("❌ Número WhatsApp inválido (solo dígitos).", true);
      return;
    }
    if (!isValidUserOrLink(usuario)) {
      showStatus("❌ Usuario/link inválido. Usa @usuario o https://...", true);
      return;
    }

    const wa_full = (codigo_pais + celular).replace(/\s/g,"");

    // Bloqueo local
    if (isAlreadyGenerated(wa_full)) {
      showStatus("✅ Ya existe un cupón generado con este WhatsApp en este dispositivo.", true);
      return;
    }

    const cupon = makeTrapCode();

    const payload = {
      cupon,
      nombre,
      pais,
      celular,
      email,
      red,
      usuario,
      origen: window.location.href,
      wa_full
    };

    btn.disabled = true;
    showStatus("Enviando…", false);

    try{
      // Enviamos (evitamos CORS)
      await fetch(SCRIPT_URL, {
        method: "POST",
        mode: "no-cors",
        headers: { "Content-Type": "text/plain;charset=utf-8" },
        body: JSON.stringify(payload)
      });

      // Marcamos como generado en este dispositivo
      markGenerated(wa_full);

      // Mostramos cupón visual
      couponCodeEl.textContent = cupon;
      couponNameEl.textContent = `Cliente: ${nombre}`;
      couponSocialEl.textContent = `Red: ${red} · ${usuario}`;

      formArea.style.display = "none";
      couponWrap.style.display = "block";
      showStatus("✅ Cupón generado.", false);

    }catch(err){
      console.error(err);
      showStatus("❌ Error de conexión. Revisa que tu Apps Script tenga acceso: Cualquiera.", true);
    }finally{
      btn.disabled = false;
    }
  });

  $("newBtn").addEventListener("click", () => {
    // Si quieres bloquear COMPLETAMENTE que hagan otro, comenta este botón.
    couponWrap.style.display = "none";
    formArea.style.display = "block";
    $("f").reset();
    $("status").style.display = "none";
  });
</script>

</body>
</html>

