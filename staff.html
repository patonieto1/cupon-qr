<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>CÉLINE — Validación Staff</title>
  <style>
    :root{--bg:#0a0b0d;--panel:rgba(17,19,23,.92);--text:#f2f4f7;--muted:#a6adb9;--line:rgba(255,255,255,.12);
      --gold:rgba(230,214,168,.95);--ok:#a7f3d0;--bad:#ffb4b4;}
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:var(--text);
      display:flex;align-items:center;justify-content:center;padding:24px;}
    .card{width:min(520px,100%);background:var(--panel);border:1px solid var(--line);border-radius:18px;overflow:hidden}
    .head{padding:16px;border-bottom:1px solid var(--line)}
    .title{font-weight:900;letter-spacing:1px;color:var(--gold);text-transform:uppercase}
    .content{padding:18px}
    .code{font-size:26px;font-weight:1000;letter-spacing:3px;text-align:center;margin:14px 0}
    .status{text-align:center;margin:10px 0;color:var(--muted)}
    .status.ok{color:var(--ok)} .status.bad{color:var(--bad)}
    .btn{width:100%;padding:12px 14px;border-radius:14px;border:1px solid rgba(255,255,255,.18);
      background:rgba(0,0,0,.25);color:#fff;font-weight:900;cursor:pointer}
    .small{opacity:.7;margin-top:10px;font-size:12px;text-align:center}
  </style>
</head>
<body>
  <main class="card">
    <div class="head"><div class="title">Validación Staff</div></div>
    <div class="content">
      <div class="code" id="code">—</div>
      <div class="status" id="st">Cargando...</div>
      <button class="btn" id="btn">Marcar como usado</button>
      <div class="small">Solo staff con PIN puede canjear.</div>
    </div>
  </main>

<script>
  // ✅ TU WEB APP NUEVA (LA QUE ME DISTE)
  const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyWS5o7ukFrx0VOQjN1huaxgUtfXGkRgp5O__J3Ui5ccUIQVObLbSf9vjKPwKFr1gephA/exec";

  const $ = (id) => document.getElementById(id);
  const params = new URLSearchParams(window.location.search);
  const c = (params.get("c") || "").trim();

  $("code").textContent = c || "—";

  async function check(){
    if(!c){ $("st").textContent="Falta código."; $("st").className="status bad"; return; }
    try{
      const r = await fetch(`${SCRIPT_URL}?action=check&c=${encodeURIComponent(c)}`);
      const j = await r.json();
      if(j.ok && j.status==="VALIDO"){ $("st").textContent="✅ Cupón válido (no usado)."; $("st").className="status ok"; }
      else if(j.ok && j.status==="USADO"){ $("st").textContent="⚠️ Cupón YA USADO."; $("st").className="status bad"; }
      else { $("st").textContent="❌ Cupón NO EXISTE."; $("st").className="status bad"; }
    }catch{
      $("st").textContent="Sin conexión para validar.";
      $("st").className="status bad";
    }
  }

  async function redeem(){
    const pin = prompt("PIN de caja:");
    if(!pin) return;
    try{
      const r = await fetch(`${SCRIPT_URL}?action=redeem&c=${encodeURIComponent(c)}&pin=${encodeURIComponent(pin)}`);
      const j = await r.json();
      if(j.ok && (j.status==="CANJEADO" || j.status==="USADO")){
        alert("✅ Canje realizado / ya estaba usado.");
      }else{
        alert("❌ No autorizado o error.");
      }
      await check();
    }catch{
      alert("Sin conexión para canjear.");
    }
  }

  $("btn").addEventListener("click", redeem);
  check();
</script>
</body>
</html>
